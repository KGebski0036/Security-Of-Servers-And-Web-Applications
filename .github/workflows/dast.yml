name: DAST Scanner Workflow

on:
  workflow_call: # POPRAWKA: Umożliwia wywołanie przez ci.yml (w przeciwieństwie do workflow_dispatch)
    # Definicja zmiennych/sekretów, które przyjmujemy od wywołującego workflowa (ci.yml)
    inputs:
      target_url:
        required: false
        type: string
        default: 'http://localhost:8000/api/'
        description: 'URL aplikacji do skanowania DAST (lokalny lub staging).'
      healthcheck_url:
        required: false
        type: string
        default: 'http://localhost:8000/api/whoami/'
        description: 'Opcjonalny URL healthcheck (np. https://.../api/whoami/). Gdy pusty, sprawdzamy tylko dostepnosc target_url.'
      start_local_backend:
        required: false
        type: boolean
        default: true
        description: 'Czy uruchamiac lokalny backend Django przed skanem.'

jobs:
  run_dast:
    name: Run OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        if: ${{ inputs.start_local_backend }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        if: ${{ inputs.start_local_backend }}
        working-directory: backend
        run: pip install -r requirements.txt

      - name: Start Django server
        if: ${{ inputs.start_local_backend }}
        working-directory: backend
        env:
          USE_SQLITE: "1"
          SECRET_KEY: dummy
          DEBUG: "1"
          DB_NAME: dummy
          DB_USER: dummy
          DB_PASSWORD: dummy
          DB_HOST: localhost
          DB_PORT: "5432"
        run: |
          python manage.py migrate --noinput
          python manage.py runserver 0.0.0.0:8000 > /tmp/django.log 2>&1 &
          echo $! > /tmp/django.pid
      
      - name: Wait for target to respond
        run: |
          health_url="${{ inputs.healthcheck_url }}"
          if [ -z "$health_url" ]; then
            health_url="${{ inputs.target_url }}"
            curl_flags="-sS"
          else
            curl_flags="-fsS"
          fi

          for i in $(seq 1 30); do
            if curl $curl_flags -o /dev/null "$health_url"; then
              exit 0
            fi
            sleep 2
          done

          echo "Backend nie wstal w oczekiwanym czasie: $health_url"
          if [ -f /tmp/django.log ]; then
            cat /tmp/django.log
          fi
          exit 1

      - name: OWASP ZAP Baseline Scan
        run: |
          mkdir -p zap-reports
          set +e
          docker pull ghcr.io/zaproxy/zaproxy:stable -q
          docker run --rm --network host -u root \
            -v "$GITHUB_WORKSPACE:/zap/wrk/:rw" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t "${{ inputs.target_url }}" -a \
              -J /zap/wrk/zap-reports/report_json.json \
              -w /zap/wrk/zap-reports/report_md.md \
              -r /zap/wrk/zap-reports/report_html.html
          status=$?
          set -e
          if [ $status -gt 2 ]; then
            echo "ZAP failed with exit code $status"
            exit $status
          fi

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: zap-reports
          
      # Dodatkowy krok do weryfikacji wyniku (opcjonalny, ale przydatny)
      - name: DAST Result Check
        run: |
          echo "Skan DAST zakończony pomyślnie. Aplikacja przechodzi do wdrożenia Produkcyjnego."

      - name: Stop Django server
        if: ${{ inputs.start_local_backend && always() }}
        run: |
          if [ -f /tmp/django.pid ]; then
            kill "$(cat /tmp/django.pid)" || true
          fi
